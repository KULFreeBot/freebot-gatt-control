= CapBot control using Bluetooth Low Energy
:icons: font
:lang: en

WARNING: This is currently a *work in progress*, it's by no means finished nor stable.

:toc: left

This repo can be divided in two main parts:

* link:./robot/[CapBot firmware] that exposes a GATT server (i.e. the BLE peripheral)
* A link:./controller/[command line interface] that connects to this GATT server (i.e. the BLE central)

== Robot Control Service
[[rcs-gatt]]

A custom GATT service is used for interacting with a robot.
This service has UUID `00000030-0000-1000-8000-00805f9b34fb` and supports the following characteristics:

.Characteristics of our robot control service (RCS)
[options=header, cols="1,3a"]
|===
| Name  | Characteristic UUID
| Drive | `00000031-0000-1000-8000-00805f9b34fb`
| Speed | `00000032-0000-1000-8000-00805f9b34fb`
| Angle | `00000033-0000-1000-8000-00805f9b34fb`
| Vcap  | `00000034-0000-1000-8000-00805f9b34fb`
|===

=== Drive

.Format of drive characteristic
[cols="2, 1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1"]
|===
| | 0 | | | | 4 | | | | 8 | | | | 12 | | |

s| Drive
^m| FL
^m| FR
^m| BL
^m| BR
4+^m| DUR
8+^m| /
|===

* `FL`: Target speed (RPM) for Front Left motor
* `FR`: Target speed (RPM) for Front Right motor
* `BL`: Target speed (RPM) for Back Left motor
* `BR`: Target speed (RPM) for Back Right motor
* `DUR`: The amount of milliseconds to keep these target speeds before stopping again

=== Speed

.Format of speed characteristic
[cols="2, 1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1"]
|===
| | 0 | | | | 4 | | | | 8 | | | | 12 | | |

s| Speed
^m| FL
^m| FR
^m| BL
^m| BR
12+^m| /
|===

* `FL`: Measured speed (RPM) of Front Left motor
* `FR`: Measured speed (RPM) of Front Right motor
* `BL`: Measured speed (RPM) of Back Left motor
* `BR`: Measured speed (RPM) of Back Right motor

=== Angle

.Format of angle characteristic
[cols="2, 1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1"]
|===
| | 0 | | | | 4 | | | | 8 | | | | 12 | | |

s| Angle
4+^m| FL
4+^m| FR
4+^m| BL
4+^m| BR
|===

* `FL`: Measured angle (째) of Front Left motor
* `FR`: Measured angle (째) of Front Right motor
* `BL`: Measured angle (째) of Back Left motor
* `BR`: Measured angle (째) of Back Right motor

=== Vcap

.Format of Vcap characteristic
[cols="2, 1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1"]
|===
| | 0 | | | | 4 | | | | 8 | | | | 12 | | |

s| Vcap
2+^m| VOLT
14+^|/
|===

* `VOLT`: Capacitor voltage (mV)

== Robot firmware

The robot firmware is based on link:https://github.com/nrfconnect/sdk-zephyr[Nordic's flavor of zephyr] and their link:https://docs.nordicsemi.com/bundle/ncs-latest[nRF Connect SDK].

== Command line interface

The controller CLI is a python program.
It connects to CapBots over BLE and uses the <<rcs-gatt, Custom GATT service>> described above.
It relies on link:https://bleak.readthedocs.io/en/latest/[bleak] for managing these connections.

=== Getting started

1. Create a python virtual environment
+
[source, console]
----
$ python -m venv venv
$ source venv/bin/activate
$ pip install --upgrade pip
----

2. Install dependencies
+
[source, console]
----
$ pip install -r controller/requirements.txt
----

3. Use BLE based CapBot controller
+
[source, console]
----
$ ./controller/capbotctl.py -h
usage: capbotctl.py [-h] [-v] [-a ADDRESS] {scan,sense,drive} ...

BLE based controller for CapBots

positional arguments:
  {scan,sense,drive}    subcommand help

options:
  -h, --help            show this help message and exit
  -v, --verbose         show verbose output
  -a ADDRESS, --address ADDRESS
----
