variables:
  PYPROJECT: controller/pyproject.toml

build:
    stage: build
    parallel:
        matrix:
            - NCS_VERSION: [v2.7.0, v2.8.0, v2.9.0]
    image: ghcr.io/nrfconnect/sdk-nrf-toolchain:$NCS_VERSION
    variables:
        DEBIAN_FRONTEND: noninteractive # CI is a non-interactive shell
        ACCEPT_JLINK_LICENSE: 0         # JLink isn't needed for building
    script:
        - cd robot
        - west init --local --manifest-file west-ncs-$NCS_VERSION.yml
        - west update
        - west build --no-sysbuild --board capbot
    cache:
        key: west-cache-$NCS_VERSION
        paths:
        - deps/
    artifacts:
      when: on_success
      expire_in: "1 week"
      paths:
        - robot/build/

mypy:
    image: python:latest
    stage: test
    before_script:
        - python -m pip install --upgrade pip
        - pip install '.'
        - pip install mypy
    script:
        - mypy --config-file $PYPROJECT $(git ls-files '*.py')

ruff:
    image: python:latest
    stage: test
    before_script:
        - python -m pip install --upgrade pip
        - pip install '.'
        - pip install ruff
    script:
        - ruff --config $PYPROJECT check $(git ls-files '*.py')
    allow_failure: true
